---
layout: post
title: CVE-2013-6393 - Heap-based buffer overflow in libyaml
---

**IMPORTANT:** This information has been superseded by a [more comprehensive
post][rubysec_post] on rubysec-announce to which I contributed.  I will leave
this entry here for archival purposes.

## Summary

The libyaml library [was found][rhbug_1033990] to contain a heap-based buffer
overflow.  This library is used by MRI ruby, optionally in 1.9.2 and by
default in 1.9.3 and later.  All users should upgrade immediately.

## Am I vulnerable?

You can check your version of libyaml by examining the
`Psych::LIBYAML_VERSION` constant in an irb session:

```ruby
require 'yaml'

Psych::LIBYAML_VERSION
#   => "0.1.5"
```

You can also be extra efficient and check via a single shell command (inspired
by [@sferik][sferik_tweet]):

```bash
ruby -r yaml -e 'puts Psych::LIBYAML_VERSION'
#   => 0.1.5
```

If you see any version lower than 0.1.5, you should upgrade immediately.

### Special note for Linux users

It's common for Linux distributions to backport security fixes to older
versions of software they are distributing.  If you have installed libyaml via
your distribution's package manager, the version number in
`Psych::LIBYAML_VERSION` may not tell the whole story.  Check the list of
locally installed packages to see if libyaml is present and if it has been
recently updated.  Some package management systems may include package release
notes that specify whether security fixes have been included.

## How do I upgrade?

### OS X

#### Homebrew

If you've installed libyaml via Homebrew (either explicitly, or implicitly
by using rvm, ruby-build, or ruby-install), you can manually upgrade it with a
few `brew` commands:

```bash
# Update Homebrew to get the latest
# forumla.
brew update

# Upgrade libyaml.
brew upgrade libyaml

# Clean up the old version (use -n
# to check what will happen first).
brew cleanup -n libyaml
```

MacPorts should have a similar process, though I'm not familiar enough with
the commands to document it.

#### System ruby

Apple included ruby 2.0.0 with OS X 10.9 Maverics, and thus libyaml 0.1.4 was
also included as a dependency.  You will either need to wait for Apple to
release a security patch (which could take a while, sadly), or build your own
copy of libyaml and ruby.  I suggest using [chruby][] or [rvm][] for this (or
[rbenv][], with which I have no experience).

### Linux

#### Compiled from source

If you installed libyaml by compiling from source, you'll need to do the same
for the new version.  If you have the source tree from the old version lying
around, you can actually run `sudo make uninstall` from within the top-level
directory to cleanly uninstall the library.  (If you don't have it anymore,
you could recreate the necessary config and Makefile environment in order to
run `make uninstall`...or you could just not worry about uninstalling first
and probably be OK...)  Next use the download link available on the [project
homepage][libyaml_home], unpack it somewhere reasonable, and execute the
standard build and install process:

```bash
# Build and install.
./configure
make
sudo make install

# Update the ld.so cache.
sudo ldconfig
```

#### Package manager

If you installed libyaml using a package provided by your distribution, check
if an update is available.  Updated packages have already been released for
Debian, Ubuntu, Fedora, and Arch.  These should become available from official
mirrors soon if they haven't already.  See your distribution's package
documentation for the proper set of commands needed to search and upgrade a
package.

#### Ruby version manager or installer script

If you are using a ruby version manager (e.g. rvm, ruby-install,
ruby-build, etc), it's quite possible that libyaml was installed
automatically.  Depending on which of these scripts you're using, and which
distribution you are running, libyaml could have been installed via your
package manager or it could have been compiled from source.  Your best bet
would be to first check your locally installed packages for libyaml and upgrade
it accordingly.  If ruby still reports that it is using an older version, or
if you do not find it in the list of locally installed packages, check in
/usr/local/lib for libyaml* files.  Presence of the latter would suggest that
libyaml was built from source using the default installation prefix.

### Windows

I am unfamiliar with running ruby on Windows platforms, though I'm happy to
include or link to instructions provided by someone else.

### IMPORTANT NOTE for all platforms

Regardless of how libyaml came to be installed on your system,
you will need to restart any long-running ruby processes after you complete
the upgrade.  This includes application servers or background job worker
processes.  For servers that support binary reexecution (e.g. Unicorn), in my
testing, a SIGUSR2/SIGQUIT to the master process appears to be sufficient to
pick up the new version of the libyaml library.

## References

* [rubysec-announce post][rubysec_post]
* [RedHat security bug #1033990][rhbug_1033990]
* [Fedora tracking bug #1059009][rhbug_1059009]
* [Debian security tracking bug #737076][debian_737076]
* [Canonical security page for CVE-2013-6393][canonical_cve]
* [LibYAML project home][libyaml_home]
* [LibYAML project on bitbucket][libyaml_source]

[rhbug_1033990]: https://bugzilla.redhat.com/show_bug.cgi?id=1033990
[rhbug_1059009]: https://bugzilla.redhat.com/show_bug.cgi?id=1059009
[debian_737076]: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=737076
[canonical_cve]: http://people.canonical.com/~ubuntu-security/cve/2013/CVE-2013-6393.html
[libyaml_home]: http://pyyaml.org/wiki/LibYAML
[libyaml_source]: https://bitbucket.org/xi/libyaml/overview

[rubysec_post]: https://groups.google.com/d/topic/rubysec-announce/3sx25iR7yHQ
[sferik_tweet]: https://twitter.com/sferik/status/430687492300623872
[chruby]: https://github.com/postmodern/chruby/
[rvm]: http://rvm.io
[rbenv]: https://github.com/sstephenson/rbenv/
